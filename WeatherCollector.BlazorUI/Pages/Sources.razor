@page "/sources"
@using WeatherCollector.Interfaces.Repositories;
@using WeatherCollector.Domain;
@inject IRepository<Source> _repository;

<div class="head-container">
    <div class="search-bar">
        <i class="bx bx-search"></i>
        <input type="text" @bind="_filter" @bind:event="oninput" placeholder="Search..." />
    </div>

    <button class="create-btn">
        Create a new source
    </button>
</div>

<div class="container centered">
    @if (SortedSources is { } sources)
    {
        <table>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th>Details</th>
                    <th class="actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var source in sources)
                {
                    <tr>
                        <td>@source.Id</td>
                        <td>@source.Name</td>
                        <td>@source.Details</td>
                        <td class="actions">
                            <button class="edit-btn">
                                <i class='bx bx-edit'></i>
                            </button>
                            <button class="remove-btn" @onclick="() => Delete(source)">
                                <i class='bx bx-trash-alt'></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>Loading...</p>
    }
</div>

<!--Create source modal-->
<div class="modal-container">
    <div class="modal">
        <div class="content">
            <header>
                <h2>Create a new source</h2>
                <i class='bx bx-x'></i>
            </header>
            <EditForm Model="_newSourceModel" OnValidSubmit="Create">
                <div class="field">
                    <label>Name</label>
                    <InputText id="new-datasource-name" @bind-Value="_newSourceModel.Name" />
                </div>
                <div class="field">
                    <label>Details</label>
                    <InputTextArea id="new-datasource-description" @bind-Value="_newSourceModel.Details" />
                </div>
                <button type="submit">Create</button>
            </EditForm>
        </div>
    </div>
</div>


@code {
    private IList<Source>? _sources;

    private Source _newSourceModel = new();

    private string? _filter;

    private IEnumerable<Source>? SortedSources =>
        string.IsNullOrWhiteSpace(_filter) ? _sources 
        : _sources?.Where(s => s.Id.ToString() == _filter 
            || (s.Name?.Contains(_filter) ?? false) 
            || (s.Details?.Contains(_filter) ?? false));

    protected override async Task OnInitializedAsync() => await Load();

    private async Task Load() => _sources = (await _repository.GetAll()).ToList();

    private async Task Create()
    {
        var createdSource = await _repository.Create(_newSourceModel);
        if (createdSource is null) return;

        _sources?.Add(createdSource);
        _newSourceModel = new();
    }

    private async Task Delete(Source? source)
    {
        if (_sources is not { Count: > 0 }) return;

        var deletedSource = await _repository.Delete(source);
        if (deletedSource is not null)
            _sources.Remove(deletedSource);
    }

}
